<!DOCTYPE html>
<html>
<head>
<title>Strimmer</title>
<!--
This HTML page provides a very simple WebSocket client, that can be used to
connect to the bridge. The default feed is from http://push-pub.appspot.com and
allows you to send test items.  The bridge location should be a publicly
accessible host or IP that routes to your bridge.
-->
<style>
html {
  font-size: 18px;
}

body {
  background-color: #FFF;
  color: #222;
}

#canvas, #form {
  padding-top: 25px;
  width: 80%;
  max-width: 1200px;
  margin: 0 auto;
}

#form, #form input, #form button {
  font: normal 0.8rem/1rem "Helvetica Neue";
}

article {
  overflow-y: hidden;
  transition: all 1s;
}

a {
  color: #448866;
  text-decoration: none;
  font-weight: bold;
}

a:hover {
  color: #006600;
  text-decoration: underline;
}

article h2, article p {
  font: normal 1rem/1.5rem "Helvetica Neue";
  letter-spacing: -0.02em;
  margin: 0;
  padding: 0;
}

.info {
  font: normal 0.8rem/1.5rem "Helvetica Neue";
  color: #666;
}

.content {
  margin-bottom: 1.0rem;
}

input {
  width: 300px;
}

</style>
</head>
<body>
<div id="form">
  <input id="bridge" placeholder="bridge.myhost.com:3100"> Bridge location<br>
  <input id="feed" value="http://push-pub.appspot.com/feed"> Feed URL<br>
  <button id="btn">Subscribe</button>
</div>
<div id="canvas">

</div>
<script>
  var formEl = document.getElementById('form')
  var canvas = document.getElementById('canvas')

  document.getElementById('btn').addEventListener('click', function (e) {
    openConnection(
        document.getElementById('bridge').value,
        document.getElementById('feed').value)
  }, false)

  document.getElementById('bridge').value = location.host

  function handleNewData(data) {
    var item = JSON.parse(data)
    item.Entries.forEach(function (entry) {
      renderEntry(entry)
    })
  }

  function renderEntry(entry) {
    var article = document.createElement('article')
    var h = document.createElement('h2')
    if (entry.URL) {
      var a = document.createElement('a')
      a.href = entry.URL
      a.target = '_blank'
      a.appendChild(document.createTextNode(entry.Title))
      h.appendChild(a)
    } else {
      h.appendChild(document.createTextNode(entry.Title))
    }
    article.appendChild(h)

    var content = document.createElement('div')
    content.className = 'content'
    content.innerHTML = entry.Description // Sanitize.

    var info = document.createElement('p')
    info.className = 'info'
    var time = document.createElement('time')
    time.setAttribute('datetime', entry.Published)
    time.innerHTML = relativeDate(entry.Published)
    info.appendChild(time)
    info.appendChild(document.createTextNode(' by ' + entry.Author))
    content.appendChild(info)

    article.appendChild(content)

    canvas.insertBefore(article, canvas.firstChild)

    var height = article.offsetHeight
    article.style.height = '0'
    setTimeout(function () {
      article.style.height = height + 'px'
    }, 0)
  }

  function relativeDate(dateString) {
    var diff = Date.now() - new Date(dateString)
    diff /= 1000
    if (diff < 60) return _relativeString(diff, 'second', 5)
    diff /= 60
    if (diff < 60) return _relativeString(diff, 'minute', 1)
    diff /= 60
    if (diff < 48) return _relativeString(diff, 'hour', 1)

    return 'some time ago'
  }

  function _relativeString(count, unit, roundTo) {
    count = Math.round(count / roundTo) * roundTo
    return count + ' ' + unit + (count == 1 ? '' : 's') + ' ago'
  }


  var HISTORY = 50
  setInterval(function () {

    // Cleanup old entries that are below the fold every few seconds, but keep a
    // browsable history.
    var articles = document.getElementsByTagName('article')
    for (var i = articles.length - 1; i >= HISTORY; i--) {
      if (articles[i].getBoundingClientRect().top > document.documentElement.clientHeight) {
        articles[i].parentNode.removeChild(articles[i])
      } else {
        // Everything else must be above the fold.
        return
      }
    }

    // Update <time> tags.
    var times = document.getElementsByTagName('time')
    for (var i = 0, n = times.length; i < n; i++) {
      times[i].innerHTML = relativeDate(times[i].getAttribute('datetime'))
    }

  }, 5000)

  // var sampleData = '{"Status":"Fetched (ping) 200 86400 and parsed 1/188 entries","Entries":[{"URL":"https://medium.com/p/af1f8d824834","Title":"Knowledge and Territory","Description":"<div class=\\\"medium-feed-item\\\"><p class=\\\"medium-feed-snippet\\\">There was an earlier time when our struggles were more physically defined.</p></div>","Author":"Johannes Nelson","Published":"2014-02-16T21:27:45.000Z","Updated":"2014-02-16T21:27:45.000Z"}]}'
  // handleNewData(sampleData)

  function openConnection(bridge, feed) {
    var conn = new WebSocket('ws://' + bridge + '/bridge?feed=' +
        encodeURIComponent(feed))
    conn.onclose = function(evt) {
      console.log('Connection closed', evt)
      renderEntry({
        Title: 'Disconnected from ' + feed,
        Published: new Date().toISOString(),
        Author: 'System',
        Description: ''
      })
    }
    conn.onmessage = function(evt) {
      console.log('Message received')
      handleNewData(evt.data)
    }
  }

  if (!window['WebSocket']) {
    alert('Your browser doesn\'t support web sockets :-(')
  }
</script>
</body>
</html>
